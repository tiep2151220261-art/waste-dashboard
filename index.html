<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Qu·∫£n L√Ω R√°c ‚Äì Nh·∫≠p & ƒê·ªìng B·ªô</title>
  <style>
    :root {
      --color-primary: #1976d2;
      --color-primary-hover: #1565c0;
      --color-success: #23b486;
      --color-bg: #f9f9f9;
      --color-card: #fff;
      --color-border: #bbb;
      --color-text: #333;
    }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; margin:0; padding:20px; background:var(--color-bg); color:var(--color-text);}
    .tabs, .depart-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn, .depart-tab {
      padding: 10px 30px;
      border-radius:8px 8px 0 0;
      border:none;
      background:#eee;
      color:#1976d2;
      font-weight:600;
      cursor:pointer;
      transition: color 0.3s, background 0.3s;
    }
    .tab-btn strong, .depart-tab strong {font-weight:bold;}
    .tab-btn.active { background:#1976d2; color:#fff;}
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    h2 strong { font-weight: bold; }
    .tabs strong, .depart-tabs strong { font-weight: bold; }
    .depart-tab.active strong { color: #fff;}
    h2 { margin-top: 30px; color: var(--color-primary); font-size: 1.5em; }
    .alert { padding:12px 16px; margin:10px 0; border-radius:6px; display:none; font-size:14px;}
    .alert-success { background: #d4edda; color:#155724; border: 1px solid #c3e6cb;}
    .alert-error { background: #f8d7da; color:#721c24; border: 1px solid #f5c6cb;}
    form { background: var(--color-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 800px;}
    form label strong { font-weight: bold;}
    form label { display: block; margin: 12px 0 6px 0; font-weight: 500; font-size: 14px;}
    input, select, textarea { width: calc(100% - 24px); padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;}
    textarea { resize: vertical; min-height: 60px;}
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); box-shadow:0 0 0 3px rgba(25,118,210,0.1);}
    .table-wrap { overflow-x:auto; margin-top:20px;}
    table { border-collapse:collapse; margin:20px 0; width:100%; background:var(--color-card); border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    th, td { border:1px solid #e0e0e0; padding:12px 8px; text-align:center; font-size:14px;}
    th strong, td strong {font-weight:bold;}
    th { background: #e3f2fd; color: var(--color-primary); font-weight:600;}
    tr:nth-child(even) { background: #f8f9fa;}
    tr:hover { background:#f0f7fa;}
    .btn { background:var(--color-primary); color:#fff; border:none; padding:10px 24px; font-weight:600; border-radius:6px; cursor:pointer; font-size:14px; transition:background 0.3s; margin-right:10px; margin-top:10px;}
    .btn:hover { background:var(--color-primary-hover);}
    .download-btn { background:var(--color-success);}
    .download-btn:hover { background:#1e9e71;}
    .kpi-row { display: flex; margin: 20px 0; gap: 15px; flex-wrap: wrap;}
    .kpi-block { background:var(--color-card); border:1px solid #e0e0e0; border-radius:8px; padding:16px 20px; flex:1; min-width:140px; box-shadow:0 2px 8px rgba(0,0,0,0.08);}
    .kpi-title { font-size:13px; color:#666; margin-bottom:8px;}
    .kpi-num { font-size:1.5em; font-weight:700;}
    .chart-bar { height:200px; display:flex; align-items:flex-end; gap:30px; padding:20px; background: var(--color-card); border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08);}
    .bar { background:linear-gradient(to top,#1976d2,#42a5f5); width:50px; margin-top:auto; border-radius:8px 8px 0 0; display:flex; align-items:flex-end; justify-content:center; transition:all 0.3s; position:relative;}
    .bar span { writing-mode:vertical-lr; font-size:14px; color:#fff; font-weight:600;}
    .bar:hover { transform:translateY(-5px); box-shadow:0 4px 12px rgba(25,118,210,0.3);}
    .chart-wrap { display:flex; flex-wrap:wrap; gap:25px; margin:15px 0;}
    .chart-wrap canvas { background:var(--color-card); border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:16px; width:350px !important; height:260px !important;}
    @media (max-width: 900px) { .chart-wrap {flex-direction:column;} .chart-wrap canvas {width:100% !important; height:250px !important;} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('input')"><strong>Nh·∫≠p li·ªáu</strong></button>
    <button class="tab-btn" onclick="showTab('dashboard')"><strong>Dashboard T·ªïng h·ª£p</strong></button>
  </div>
  <div id="tab-input" class="tab-content active">
    <h2><strong>üìä Dashboard Qu·∫£n L√Ω R√°c ‚Äì Nh·∫≠p Li·ªáu & ƒê·ªìng B·ªô</strong></h2>
    <div id="alertBox" class="alert"></div>
    <form id="wasteForm" autocomplete="off">
      <label><strong>üìÖ Ng√†y:</strong> <span style="color: red;">*</span></label>
      <input type="date" id="ngay" required>
      <label><strong>üè¢ B·ªô ph·∫≠n:</strong> <span style="color: red;">*</span></label>
      <select id="bophan" required>
        <option value=""><strong>--Ch·ªçn b·ªô ph·∫≠n--</strong></option>
        <option><strong>B·∫øp</strong></option>
        <option><strong>Nh√† H√†ng</strong></option>
        <option><strong>Nh√¢n S·ª±</strong></option>
        <option><strong>K·∫ø To√°n</strong></option>
        <option><strong>Public</strong></option>
      </select>
      <label><strong>üóëÔ∏è Lo·∫°i r√°c:</strong> <span style="color: red;">*</span></label>
      <select id="loairac" required>
        <option value=""><strong>--Ch·ªçn lo·∫°i r√°c--</strong></option>
        <option><strong>H·ªØu c∆°</strong></option>
        <option><strong>T√°i ch·∫ø</strong></option>
        <option><strong>Kh√≥ t√°i ch·∫ø</strong></option>
        <option><strong>Nguy h·∫°i</strong></option>
      </select>
      <label><strong>‚öñÔ∏è Tr·ªçng l∆∞·ª£ng (kg):</strong> <span style="color: red;">*</span></label>
      <input type="number" id="trongluong" min="0" step="0.01" placeholder="V√≠ d·ª•: 2.5" required>
      <label><strong>üß™ Th·ªÉ t√≠ch (ml):</strong></label>
      <input type="number" id="thetich" min="0" step="1" placeholder="V√≠ d·ª•: 1000">
      <label><strong>‚ôªÔ∏è ƒê∆∞·ªùng ƒëi c·ªßa r√°c:</strong></label>
      <select id="duongdi">
        <option value=""><strong>--Ch·ªçn--</strong></option>
        <option><strong>L√†m enzym</strong></option>
        <option><strong>V∆∞·ªùn</strong></option>
        <option><strong>T√°i s·ª≠ d·ª•ng/Ve chai/cho heo</strong></option>
        <option><strong>Th·∫£i ra m√¥i tr∆∞·ªùng</strong></option>
      </select>
      <label><strong>üìù Ghi ch√∫:</strong></label>
      <textarea id="ghichu" placeholder="Nh·∫≠p ghi ch√∫ th√™m n·∫øu c·∫ßn..."></textarea>
      <button type="submit" class="btn">‚ûï <strong>Th√™m d·ªØ li·ªáu</strong></button>
      <button type="button" class="btn download-btn" onclick="exportCSV()">üì• <strong>T·∫£i xu·ªëng Excel (CSV)</strong></button>
    </form>
    <div class="kpi-row" id="kpis"></div>
    <h2 style="font-size:1.3em;"><strong>üìã B·∫£ng t·ªïng h·ª£p d·ªØ li·ªáu (local)</strong></h2>
    <div class="table-wrap">
      <table id="wasteTable">
        <thead>
          <tr>
            <th><strong>Ng√†y</strong></th>
            <th><strong>B·ªô ph·∫≠n</strong></th>
            <th><strong>Lo·∫°i r√°c</strong></th>
            <th><strong>Tr·ªçng l∆∞·ª£ng (kg)</strong></th>
            <th><strong>Th·ªÉ t√≠ch (ml)</strong></th>
            <th><strong>ƒê∆∞·ªùng ƒëi c·ªßa r√°c</strong></th>
            <th><strong>Ghi ch√∫</strong></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <h2 style="font-size:1.3em;"><strong>üìä Bi·ªÉu ƒë·ªì t·ªïng h·ª£p theo lo·∫°i r√°c (local)</strong></h2>
    <div id="barchart" class="chart-bar"></div>
  </div>
  <div id="tab-dashboard" class="tab-content">
    <h2><strong>üìä Dashboard T·ªïng H·ª£p</strong></h2>
    <div class="depart-tabs">
      <button class="depart-tab active" onclick="showDepartTab2('TongHop')"><strong>T·ªïng h·ª£p</strong></button>
      <button class="depart-tab" onclick="showDepartTab2('Bep')"><strong>B·∫øp</strong></button>
      <button class="depart-tab" onclick="showDepartTab2('NhaHang')"><strong>Nh√† H√†ng</strong></button>
      <button class="depart-tab" onclick="showDepartTab2('Public')"><strong>Public</strong></button>
      <button class="depart-tab" onclick="showDepartTab2('KeToan')"><strong>K·∫ø To√°n</strong></button>
      <button class="depart-tab" onclick="showDepartTab2('NhanSu')"><strong>Nh√¢n S·ª±</strong></button>
    </div>
    <div id="dashboard-modern"></div>
    <div id="dashboard-modal-bg" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;background:rgba(0,0,0,.4);justify-content:center;align-items:center;">
      <div id="dashboard-modal" style="background:white;padding:30px;border-radius:12px;max-width:650px;box-shadow:0 10px 40px #0002;position:relative;">
        <button onclick="closeDashboardModal()" style="position:absolute;top:8px;right:15px;font-size:2em;background:none;border:none;cursor:pointer;">&times;</button>
        <div id="dashboard-modal-content"></div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const DEPARTMENT_COLOR = {
      "B·∫øp": "#e67e22",
      "Nh√† H√†ng": "#3498db",
      "Public": "#27ae60",
      "K·∫ø To√°n": "#9b59b6",
      "Nh√¢n S·ª±": "#e74c3c"
    };

    /* ƒê√É ƒê·ªîI URL GOOGLE SCRIPT T·∫†I ƒê√ÇY */
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzNMUlXHG9VgZa1Bcqf4Et3od9W_MLVVMl4A2tFGuWVK-zq9N9xaJZ-WYURC7D0rznPnw/exec';

    let data = JSON.parse(localStorage.getItem('wasteData')||'[]');
    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = 'alert ' + (type === 'success' ? 'alert-success' : 'alert-error');
      alertBox.style.display = 'block';
      setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
    }
    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
      if(tab === 'input') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('tab-input').classList.add('active');
      } else {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('tab-dashboard').classList.add('active');
        showDepartTab2('TongHop');
      }
    }
    function updateTable() {
      const tb = document.getElementById('wasteTable').querySelector('tbody');
      tb.innerHTML = '';
      for(const row of data){
        let tr = tb.insertRow();
        tr.insertCell().innerText = row.ngay;
        let cellDept = tr.insertCell();
        cellDept.innerHTML = `<span style="color:${DEPARTMENT_COLOR[row.bophan] || "#333"}"><strong>${row.bophan}</strong></span>`;
        tr.insertCell().innerHTML = `<strong>${row.loairac}</strong>`;
        tr.insertCell().innerText = row.trongluong;
        tr.insertCell().innerText = row.thetich || '';
        tr.insertCell().innerText = row.duongdi || '';
        tr.insertCell().innerText = row.ghichu || '';
      }
      updateKPI();
      updateBarChart();
    }
    function updateKPI(){
      let total = 0, organic = 0, recycle = 0, difficult = 0, hazard = 0;
      for(const row of data){
        let val = parseFloat(row.trongluong) || 0;
        total += val;
        if(row.loairac === "H·ªØu c∆°") organic += val;
        else if(row.loairac === "T√°i ch·∫ø") recycle += val;
        else if(row.loairac === "Kh√≥ t√°i ch·∫ø") difficult += val;
        else if(row.loairac === "Nguy h·∫°i") hazard += val;
      }
      document.getElementById('kpis').innerHTML = `
      <div class="kpi-block" style="color:#1976d2">
        <div class="kpi-title"><strong>T·ªïng tr·ªçng l∆∞·ª£ng</strong></div>
        <div class="kpi-num">${total.toFixed(2)} kg</div>
      </div>
      <div class="kpi-block" style="color:${DEPARTMENT_COLOR['B·∫øp']}">
        <div class="kpi-title"><strong>H·ªØu c∆°</strong></div>
        <div class="kpi-num">${organic.toFixed(2)} kg</div>
      </div>
      <div class="kpi-block" style="color:${DEPARTMENT_COLOR['Nh√† H√†ng']}">
        <div class="kpi-title"><strong>T√°i ch·∫ø</strong></div>
        <div class="kpi-num">${recycle.toFixed(2)} kg</div>
      </div>
      <div class="kpi-block" style="color:${DEPARTMENT_COLOR['Public']}">
        <div class="kpi-title"><strong>Kh√≥ t√°i ch·∫ø</strong></div>
        <div class="kpi-num">${difficult.toFixed(2)} kg</div>
      </div>
      <div class="kpi-block" style="color:${DEPARTMENT_COLOR['Nh√¢n S·ª±']}">
        <div class="kpi-title"><strong>Nguy h·∫°i</strong></div>
        <div class="kpi-num">${hazard.toFixed(2)} kg</div>
      </div>
      `;
    }
    function updateBarChart() {
      let barData = { "H·ªØu c∆°": 0, "T√°i ch·∫ø": 0, "Kh√≥ t√°i ch·∫ø": 0, "Nguy h·∫°i": 0 };
      for(const row of data){
        let val = parseFloat(row.trongluong) || 0;
        if(row.loairac in barData) barData[row.loairac] += val;
      }
      const all = Object.entries(barData);
      let max = Math.max(...all.map(d => d[1]), 1);
      let html = '';
      for(const [l, v] of all){
        const colorMap = {
          "H·ªØu c∆°": "#23b486",
          "T√°i ch·∫ø": "#1976d2",
          "Kh√≥ t√°i ch·∫ø": "#ef5350",
          "Nguy h·∫°i": "#e68161"
        };
        const height = (v / max * 160 + 20);
        html += `<div class="bar" style="height:${height}px; background:linear-gradient(to top,${colorMap[l]},#42a5f5);" title="${l}: ${v.toFixed(2)} kg">
          ${v > 0 ? `<span><strong>${v.toFixed(1)}</strong></span>` : ''}
        </div>`;
      }
      document.getElementById('barchart').innerHTML = html;
    }
    function showDepartTab2(tab) {
      const tabMap = {
        TongHop: { label: "T·ªïngh·ª£p", color: "#1976d2" },
        Bep: { label: "B·∫øp", color: DEPARTMENT_COLOR["B·∫øp"] },
        NhaHang: { label: "Nh√†H√†ng", color: DEPARTMENT_COLOR["Nh√† H√†ng"] },
        Public: { label: "Public", color: DEPARTMENT_COLOR["Public"] },
        KeToan: { label: "K·∫øTo√°n", color: DEPARTMENT_COLOR["K·∫ø To√°n"] },
        NhanSu: { label: "Nh√¢nS·ª±", color: DEPARTMENT_COLOR["Nh√¢n S·ª±"] }
      };
      document.querySelectorAll('.depart-tab').forEach(btn => {
        btn.classList.remove('active');
        btn.style.color = "#1976d2";
        btn.style.background = "#eee";
        Object.entries(tabMap).forEach(([k, v]) => {
          if (btn.textContent.replace(/\s/g, '') === v.label) {
            if (k === tab) {
              btn.classList.add('active');
              btn.style.color = "#fff";
              btn.style.background = v.color;
            }
          }
        });
      });
      DASHBOARD_TAB2 = tab;
      updateModernDashboard();
    }
    document.getElementById('wasteForm').onsubmit = async function(e){
      e.preventDefault();
      let ng = document.getElementById('ngay').value;
      let bp = document.getElementById('bophan').value;
      let lr = document.getElementById('loairac').value;
      let tl = document.getElementById('trongluong').value;
      let tt = document.getElementById('thetich').value;
      let dd = document.getElementById('duongdi').value;
      let gc = document.getElementById('ghichu').value;
      if(!ng || !bp || !lr || !tl){
        showAlert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!', 'error');
        return;
      }
      const newData = { ngay: ng, bophan: bp, loairac: lr, trongluong: tl, thetich: tt, duongdi: dd, ghichu: gc };
      data.push(newData);
      localStorage.setItem('wasteData', JSON.stringify(data));
      updateTable();
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(newData)
        });
        showAlert('‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu v√† g·ª≠i l√™n Google Sheets th√†nh c√¥ng!', 'success');
      } catch(error) {
        showAlert('‚úÖ ƒê√£ l∆∞u local. ‚ö†Ô∏è L·ªói khi g·ª≠i l√™n Google Sheets: ' + error.message, 'error');
      }
      this.reset();
    }
    function exportCSV() {
      if(data.length == 0){
        alert('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i xu·ªëng!');
        return;
      }
      let csv = 'Ng√†y,B·ªô ph·∫≠n,Lo·∫°i r√°c,Tr·ªçng l∆∞·ª£ng (kg),Th·ªÉ t√≠ch (ml),ƒê∆∞·ªùng ƒëi c·ªßa r√°c,Ghi ch√∫\n';
      for(const r of data){
        csv += `${r.ngay},${r.bophan},${r.loairac},${r.trongluong},${r.thetich||''},${r.duongdi||''},${r.ghichu||''}\n`;
      }
      let blob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
      let link = document.createElement('a');
      link.download = 'du-lieu-quan-ly-rac.csv';
      link.href = URL.createObjectURL(blob);
      link.click();
    }
    updateTable();
    function groupedSummaryByDepartment() {
      const raw = JSON.parse(localStorage.getItem('wasteData')||'[]');
      const boPhans = ['B·∫øp','Nh√† H√†ng','Public','K·∫ø To√°n','Nh√¢n S·ª±'];
      let summary = {};
      for (const bp of boPhans) {
        summary[bp] = {
          total: 0,
          organic: 0,
          recycle: 0,
          difficult: 0,
          hazard: 0
        };
      }
      for (const row of raw) {
        if (!summary[row.bophan]) continue;
        let val = parseFloat(row.trongluong) || 0;
        summary[row.bophan].total += val;
        if (row.loairac === 'H·ªØu c∆°') summary[row.bophan].organic += val;
        if (row.loairac === 'T√°i ch·∫ø') summary[row.bophan].recycle += val;
        if (row.loairac === 'Kh√≥ t√°i ch·∫ø') summary[row.bophan].difficult += val;
        if (row.loairac === 'Nguy h·∫°i') summary[row.bophan].hazard += val;
      }
      return summary;
    }
    let DASHBOARD_TAB2 = 'TongHop';
    function dashboardDataByTab(tab) {
      const raw = JSON.parse(localStorage.getItem('wasteData')||'[]');
      let rows = (tab==='TongHop') ? raw
        : raw.filter(row =>
            (tab==='Bep'&&row.bophan==='B·∫øp')
         || (tab==='NhaHang'&&row.bophan==='Nh√† H√†ng')
         || (tab==='Public'&&row.bophan==='Public')
         || (tab==='KeToan'&&row.bophan==='K·∫ø To√°n')
         || (tab==='NhanSu'&&row.bophan==='Nh√¢n S·ª±')
        );
      let typeNames = {organic:'H·ªØu c∆°',recycle:'T√°i ch·∫ø',difficult:'Kh√≥ t√°i ch·∫ø',hazard:'Nguy h·∫°i'};
      let sum = {organic:0,recycle:0,difficult:0,hazard:0,vuon:0,taisudung:0,thaira:0,count:0}, total=0;
      let byType = {organic:0,recycle:0,difficult:0,hazard:0};
      let byWay = {vuon:0,taisudung:0,thaira:0};
      let details = {organic:{},recycle:{},difficult:{},hazard:{}};
      for(const row of rows){
        let v=parseFloat(row.trongluong)||0, t=row.loairac, way=row.duongdi;
        sum.count++; total+=v;
        let cat=t==='H·ªØu c∆°'?'organic':t==='T√°i ch·∫ø'?'recycle':t==='Kh√≥ t√°i ch·∫ø'?'difficult':t==='Nguy h·∫°i'?'hazard':null;
        if(cat) {byType[cat]+=v; sum[cat]+=v;}
        if(way==='V∆∞·ªùn') {sum.vuon+=v; byWay.vuon+=v;}
        if(way==='T√°i s·ª≠ d·ª•ng/Ve chai/cho heo') {sum.taisudung+=v; byWay.taisudung+=v;}
        if(way==='Th·∫£i ra m√¥i tr∆∞·ªùng') {sum.thaira+=v; byWay.thaira+=v;}
        if(cat&&!details[cat][way]) details[cat][way]=0;
        if(cat&&way) details[cat][way]+=v;
      }
      sum.total=total;
      return {rows, sum, byType, byWay, details, typeNames};
    }
    function updateModernDashboard() {
      const data = dashboardDataByTab(DASHBOARD_TAB2);
      let kpi = `
        <div class="kpi-row" style="margin-bottom:16px;">
          <div class="kpi-block" style="color:#1976d2"><div class="kpi-title"><strong>T·ªïng tr·ªçng l∆∞·ª£ng</strong></div><div class="kpi-num">${data.sum.total.toFixed(2)} kg</div></div>
          <div class="kpi-block" style="color:${DEPARTMENT_COLOR['B·∫øp']}"><div class="kpi-title"><strong>H·ªØu c∆°</strong></div><div class="kpi-num">${data.sum.organic.toFixed(2)} kg</div></div>
          <div class="kpi-block" style="color:${DEPARTMENT_COLOR['Nh√† H√†ng']}"><div class="kpi-title"><strong>T√°i ch·∫ø</strong></div><div class="kpi-num">${data.sum.recycle.toFixed(2)} kg</div></div>
          <div class="kpi-block" style="color:${DEPARTMENT_COLOR['Public']}"><div class="kpi-title"><strong>Kh√≥ t√°i ch·∫ø</strong></div><div class="kpi-num">${data.sum.difficult.toFixed(2)} kg</div></div>
          <div class="kpi-block" style="color:${DEPARTMENT_COLOR['Nh√¢n S·ª±']}"><div class="kpi-title"><strong>Nguy h·∫°i</strong></div><div class="kpi-num">${data.sum.hazard.toFixed(2)} kg</div></div>
        </div>`;
      let canvas = `
        <div class="chart-wrap" style="padding:0;gap:18px 2%;margin:0;">
          <canvas id="dashboardPie" style="width:250px;height:250px"></canvas>
          <canvas id="dashboardBar" style="width:250px;height:250px"></canvas>
          <canvas id="dashboardStacked" style="width:250px;height:250px"></canvas>
          <canvas id="dashboardLine" style="width:250px;height:250px"></canvas>
          <canvas id="dashboardDeptCompare" style="width:250px;height:250px"></canvas>
          <canvas id="dashboard2D" style="width:350px;height:280px"></canvas>
        </div>`;
      let detailedRows = '';
      for(const [cat,title] of Object.entries(data.typeNames)){
        detailedRows += `<tr>
          <td><strong>${title}</strong></td>
          <td>${data.byType[cat].toFixed(2)}</td>
          <td>${(data.details[cat]?.['V∆∞·ªùn']||0).toFixed(2)}</td>
          <td>${(data.details[cat]?.['T√°i s·ª≠ d·ª•ng/Ve chai/cho heo']||0).toFixed(2)}</td>
          <td>${(data.details[cat]?.['Th·∫£i ra m√¥i tr∆∞·ªùng']||0).toFixed(2)}</td>
        </tr>`;
      }
      let table = `
        <h3 style="margin-bottom:7px;"><strong>üìã B·∫£ng t√≥m t·∫Øt ph√¢n lo·∫°i r√°c</strong></h3>
        <table id="tableDashboardSummary" style="width:100%;">
          <thead><tr>
            <th><strong>Lo·∫°i r√°c</strong></th>
            <th><strong>T·ªïng tr·ªçng l∆∞·ª£ng (kg)</strong></th>
            <th><strong>V∆∞·ªùn</strong></th>
            <th><strong>T√°i s·ª≠ d·ª•ng/Ve chai/cho heo</strong></th>
            <th><strong>Th·∫£i ra m√¥i tr∆∞·ªùng</strong></th>
          </tr></thead>
          <tbody>${detailedRows}</tbody>
        </table>`;
      const departmentSummary = groupedSummaryByDepartment();
      let deptsCompare = `<h3 style="margin-bottom:7px;"><strong>üßæ So s√°nh c√°c b·ªô ph·∫≠n</strong></h3>
      <table style="width:100%;background:#fff">
        <thead>
          <tr>
            <th><strong>B·ªô ph·∫≠n</strong></th>
            <th><strong>T·ªïng (kg)</strong></th>
            <th><strong>H·ªØu c∆°</strong></th>
            <th><strong>T√°i ch·∫ø</strong></th>
            <th><strong>Kh√≥ t√°i ch·∫ø</strong></th>
            <th><strong>Nguy h·∫°i</strong></th>
          </tr>
        </thead>
        <tbody>
          ${Object.entries(departmentSummary).map(([bp,data])=>`
            <tr>
              <td style="color:${DEPARTMENT_COLOR[bp]||'#333'}"><strong>${bp}</strong></td>
              <td>${data.total.toFixed(2)}</td>
              <td>${data.organic.toFixed(2)}</td>
              <td>${data.recycle.toFixed(2)}</td>
              <td>${data.difficult.toFixed(2)}</td>
              <td>${data.hazard.toFixed(2)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
      table += deptsCompare;
      document.getElementById('dashboard-modern').innerHTML = kpi + canvas + table;
      setTimeout(()=>renderModernCharts(data),120);
    }
    let dashboardPieObj, dashboardBarObj, dashboardStackedObj, dashboardLineObj, dashboardDeptCompareObj;
    function renderModernCharts(data){
      let ctxPie = document.getElementById("dashboardPie").getContext('2d');
      dashboardPieObj && dashboardPieObj.destroy();
      dashboardPieObj = new Chart(ctxPie, {
        type: "pie",
        data: {
          labels: ["H·ªØu c∆°","T√°i ch·∫ø","Kh√≥ t√°i ch·∫ø","Nguy h·∫°i"],
          datasets:[{
            data:[data.sum.organic,data.sum.recycle,data.sum.difficult,data.sum.hazard],
            backgroundColor: ['#23b486','#1976d2','#ef5350','#e68161']
          }]
        },
        options:{
          plugins:{
            legend: { labels: { font: { size: 28 }, color: "#023047"} },
            title: {display:true, text:"C∆° c·∫•u lo·∫°i r√°c", color:"#23b486", font:{size: 32}}
          }
        }
      });
      let ctxBar = document.getElementById("dashboardBar").getContext('2d');
      dashboardBarObj && dashboardBarObj.destroy();
      dashboardBarObj = new Chart(ctxBar, {
        type:"bar",
        data:{
          labels:["V∆∞·ªùn","T√°i s·ª≠ d·ª•ng/Ve chai/cho heo","Th·∫£i ra m√¥i tr∆∞·ªùng"],
          datasets:[{
            label:"Tr·ªçng l∆∞·ª£ng (kg)",
            data:[data.byWay.vuon,data.byWay.taisudung,data.byWay.thaira],
            backgroundColor:['#23b486','#1976d2','#ef5350']
          }]
        },
        options:{
          plugins:{
            legend: { labels: { font: { size: 26 }, color: "#009688"} },
            title: {display:true, text:"Ph√¢n b·ªï theo ƒë∆∞·ªùng ƒëi", color:"#009688", font:{size: 30}}
          },
          scales:{
            x:{ticks:{font:{size:24}, color:"#009688"}},
            y:{ticks:{font:{size:24}, beginAtZero:true, color:"#009688"}}
          }
        }
      });
      let ctxStacked = document.getElementById("dashboardStacked").getContext('2d');
      dashboardStackedObj && dashboardStackedObj.destroy();
      dashboardStackedObj = new Chart(ctxStacked, {
        type:"bar",
        data:{
          labels:["H·ªØu c∆°","T√°i ch·∫ø","Kh√≥ t√°i ch·∫ø","Nguy h·∫°i"],
          datasets:[
            {label:"V∆∞·ªùn", data:[data.details.organic['V∆∞·ªùn']||0, data.details.recycle['V∆∞·ªùn']||0, data.details.difficult['V∆∞·ªùn']||0, data.details.hazard['V∆∞·ªùn']||0], backgroundColor:"#23b486"},
            {label:"T√°i s·ª≠ d·ª•ng", data:[data.details.organic['T√°i s·ª≠ d·ª•ng/Ve chai/cho heo']||0, data.details.recycle['T√°i s·ª≠ d·ª•ng/Ve chai/cho heo']||0, data.details.difficult['T√°i s·ª≠ d·ª•ng/Ve chai/cho heo']||0, data.details.hazard['T√°i s·ª≠ d·ª•ng/Ve chai/cho heo']||0], backgroundColor:"#1976d2"},
            {label:"Th·∫£i ra", data:[data.details.organic['Th·∫£i ra m√¥i tr∆∞·ªùng']||0, data.details.recycle['Th·∫£i ra m√¥i tr∆∞·ªùng']||0, data.details.difficult['Th·∫£i ra m√¥i tr∆∞·ªùng']||0, data.details.hazard['Th·∫£i ra m√¥i tr∆∞·ªùng']||0], backgroundColor:"#ef5350"}
          ]
        },
        options:{
          plugins:{
            legend:{ position:'bottom', labels:{font:{size:28}, color:"#b71c1c"} },
            title: {display:true, text:"Chi ti·∫øt lo·∫°i & ƒë∆∞·ªùng ƒëi", color:"#b71c1c", font:{size:30}}
          },
          scales:{
            x:{stacked:true, ticks:{font:{size:24}, color:"#b71c1c"}},
            y:{stacked:true, ticks:{font:{size:24},beginAtZero:true, color:"#b71c1c"}}
          }
        }
      });
      let lineData={};
      data.rows.forEach(r=>{
        let d=r.ngay;
        lineData[d]=(lineData[d]||0)+(parseFloat(r.trongluong)||0);
      });
      let ctxLine = document.getElementById("dashboardLine").getContext('2d');
      dashboardLineObj && dashboardLineObj.destroy();
      dashboardLineObj = new Chart(ctxLine,{
        type:"line",
        data:{
          labels:Object.keys(lineData),
          datasets:[{label:"T·ªïng m·ªói ng√†y",data:Object.values(lineData),borderColor:"#1976d2",backgroundColor:"#23b486"}]
        },
        options:{
          plugins:{
            legend:{ position:"bottom", labels:{font:{size:28}, color:"#1976d2"} },
            title:{display:true, text:"Di·ªÖn bi·∫øn t·ªïng r√°c theo ng√†y", color:"#1976d2", font:{size:30}}
          },
          scales:{
            x:{ticks:{font:{size:24}, color:"#1976d2"}},
            y:{ticks:{font:{size:24},beginAtZero:true, color:"#1976d2"}}
          }
        }
      });
      const departmentSummary = groupedSummaryByDepartment();
      let deptLabels = Object.keys(departmentSummary);
      let deptValues = Object.values(departmentSummary).map(d=>d.total);
      let ctxDept = document.getElementById("dashboardDeptCompare").getContext('2d');
      dashboardDeptCompareObj && dashboardDeptCompareObj.destroy();
      dashboardDeptCompareObj = new Chart(ctxDept, {
        type:"bar",
        data:{
          labels:deptLabels,
          datasets:[{
            label:"T·ªïng tr·ªçng l∆∞·ª£ng t·ª´ng b·ªô ph·∫≠n (kg)",
            data:deptValues,
            backgroundColor:deptLabels.map(bp=>DEPARTMENT_COLOR[bp]||"#333")
          }]
        },
        options:{
          plugins:{
            legend:{labels:{font:{size:28}, color:"#333"} },
            title:{display:true, text:"So s√°nh c√°c b·ªô ph·∫≠n", color:"#333", font:{size:32}}
          },
          scales:{
            x:{
              ticks:{
                font:{size:28},
                color:function(context){
                  return DEPARTMENT_COLOR[context.tick.value] || "#333";
                }
              }
            },
            y:{ticks:{font:{size:26},beginAtZero:true, color:"#333"}}
          }
        }
      });
      let scatterData = [];
      const TYPE_COLOR = {
        "H·ªØu c∆°": "#23b486",
        "T√°i ch·∫ø": "#1976d2",
        "Kh√≥ t√°i ch·∫ø": "#ef5350",
        "Nguy h·∫°i": "#e68161"
      };
      data.rows.forEach(row => {
        if(row.trongluong && row.thetich){
          scatterData.push({
            x: parseFloat(row.trongluong),
            y: parseFloat(row.thetich),
            backgroundColor: TYPE_COLOR[row.loairac] || "#333",
            label: row.loairac
          });
        }
      });
      let ctx2D = document.getElementById("dashboard2D").getContext('2d');
      window.dashboard2DObj && window.dashboard2DObj.destroy();
      window.dashboard2DObj = new Chart(ctx2D, {
        type: 'scatter',
        data: {
          datasets: [{
            label: "Tr·ªçng l∆∞·ª£ng vs Th·ªÉ t√≠ch",
            data: scatterData.map(p => ({x: p.x, y: p.y})),
            pointBackgroundColor: scatterData.map(p => p.backgroundColor),
            pointRadius: 12,
            pointHoverRadius: 18
          }]
        },
        options: {
          plugins: {
            legend: {
              labels: { font: { size: 30 } }
            },
            title: {
              display: true,
              text: "Bi·ªÉu ƒë·ªì 2D: Tr·ªçng l∆∞·ª£ng (kg) vs Th·ªÉ t√≠ch (ml)",
              color: "#1976d2",
              font: { size: 40 }
            }
          },
          scales: {
            x: {
              title: { display: true, text: "Tr·ªçng l∆∞·ª£ng (kg)", color: "#1976d2", font: {size: 34}},
              ticks: { font: { size: 28 }, color: "#1976d2" }
            },
            y: {
              title: { display: true, text: "Th·ªÉ t√≠ch (ml)", color: "#1976d2", font: {size: 34}},
              ticks: { font: { size: 28 }, color: "#1976d2" }
            }
          }
        }
      });
    }
    function showDashboardModal(cat){}
    function closeDashboardModal(){ document.getElementById("dashboard-modal-bg").style.display = "none";}
    window.addEventListener("DOMContentLoaded",function(){ showDepartTab2('TongHop'); });
  </script>
</body>
</html>
