<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Qu·∫£n L√Ω R√°c ‚Äì Nh·∫≠p & ƒê·ªìng B·ªô</title>
  <style>
    /* ... (gi·ªØ nguy√™n ph·∫ßn css dashboard b·∫°n ƒë√£ g·ª≠i) ... */
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; margin:0; padding:20px; background:#f9f9f9; color:#333;}
    .tabs, .depart-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn, .depart-tab { padding: 10px 30px;border-radius:8px 8px 0 0;border:none;background:#eee;color:#1976d2;font-weight:600;cursor:pointer;transition: color 0.3s, background 0.3s;}
    .tab-btn strong, .depart-tab strong {font-weight:bold;}
    .tab-btn.active { background:#1976d2; color:#fff;}
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    h2 strong { font-weight: bold; }
    .depart-tab.active strong { color: #fff;}
    h2 { margin-top: 30px; color: #1976d2; font-size: 1.5em; }
    .alert-success { background: #d4edda; color:#155724; border: 1px solid #c3e6cb;}
    .alert-error { background: #f8d7da; color:#721c24; border: 1px solid #f5c6cb;}
    form { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 800px;}
    input, select, textarea { width: calc(100% - 24px); padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;}
    textarea { resize: vertical; min-height: 60px;}
    .table-wrap { overflow-x:auto; margin-top:20px;}
    table { border-collapse:collapse; margin:20px 0; width:100%; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    th, td { border:1px solid #e0e0e0; padding:12px 8px; text-align:center; font-size:14px;}
    th strong, td strong {font-weight:bold;}
    th { background: #e3f2fd; color: #1976d2; font-weight:600;}
    tr:nth-child(even) { background: #f8f9fa;}
    tr:hover { background:#f0f7fa;}
    .btn { background:#1976d2; color:#fff; border:none; padding:10px 24px; font-weight:600; border-radius:6px; cursor:pointer; font-size:14px; transition:background 0.3s; margin-right:10px; margin-top:10px;}
    .download-btn { background:#23b486;}
    .kpi-row { display: flex; margin: 20px 0; gap: 15px; flex-wrap: wrap;}
    .kpi-block { background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:16px 20px; flex:1; min-width:140px; box-shadow:0 2px 8px rgba(0,0,0,0.08);}
    .kpi-title { font-size:13px; color:#666; margin-bottom:8px;}
    .kpi-num { font-size:1.5em; font-weight:700;}
    .chart-bar { height:200px; display:flex; align-items:flex-end; gap:30px; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08);}
    .bar { background:linear-gradient(to top,#1976d2,#42a5f5); width:50px; margin-top:auto; border-radius:8px 8px 0 0; display:flex; align-items:flex-end; justify-content:center; transition:all 0.3s; position:relative;}
    .bar span { writing-mode:vertical-lr; font-size:14px; color:#fff; font-weight:600;}
    .bar:hover { transform:translateY(-5px); box-shadow:0 4px 12px rgba(25,118,210,0.3);}
    @media (max-width: 900px) { .chart-bar {flex-direction:column;} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('input')"><strong>Nh·∫≠p li·ªáu</strong></button>
    <button class="tab-btn" onclick="showTab('dashboard')"><strong>Dashboard T·ªïng h·ª£p</strong></button>
  </div>
  <div id="tab-input" class="tab-content active">
    <h2><strong>üìä Dashboard Qu·∫£n L√Ω R√°c ‚Äì Nh·∫≠p Li·ªáu & ƒê·ªìng B·ªô</strong></h2>
    <div id="alertBox"></div>
    <form id="wasteForm" autocomplete="off">
      <label><strong>üìÖ Ng√†y:</strong> <span style="color: red;">*</span></label>
      <input type="date" id="ngay" required>
      <label><strong>üè¢ B·ªô ph·∫≠n:</strong> <span style="color: red;">*</span></label>
      <select id="bophan" required>
        <option value=""><strong>--Ch·ªçn b·ªô ph·∫≠n--</strong></option>
        <option><strong>B·∫øp</strong></option>
        <option><strong>Nh√† H√†ng</strong></option>
        <option><strong>Nh√¢n S·ª±</strong></option>
        <option><strong>K·∫ø To√°n</strong></option>
        <option><strong>Public</strong></option>
      </select>
      <label><strong>üóëÔ∏è Lo·∫°i r√°c:</strong> <span style="color: red;">*</span></label>
      <select id="loairac" required>
        <option value=""><strong>--Ch·ªçn lo·∫°i r√°c--</strong></option>
        <option><strong>H·ªØu c∆°</strong></option>
        <option><strong>T√°i ch·∫ø</strong></option>
        <option><strong>Kh√≥ t√°i ch·∫ø</strong></option>
        <option><strong>Nguy h·∫°i</strong></option>
      </select>
      <label><strong>‚öñÔ∏è Tr·ªçng l∆∞·ª£ng (kg):</strong> <span style="color: red;">*</span></label>
      <input type="number" id="trongluong" min="0" step="0.01" placeholder="V√≠ d·ª•: 2.5" required>
      <label><strong>üß™ Th·ªÉ t√≠ch (ml):</strong></label>
      <input type="number" id="thetich" min="0" step="1" placeholder="V√≠ d·ª•: 1000">
      <label><strong>‚ôªÔ∏è ƒê∆∞·ªùng ƒëi c·ªßa r√°c:</strong></label>
      <select id="duongdi">
        <option value=""><strong>--Ch·ªçn--</strong></option>
        <option><strong>L√†m enzym</strong></option>
        <option><strong>V∆∞·ªùn</strong></option>
        <option><strong>T√°i s·ª≠ d·ª•ng/Ve chai/cho heo</strong></option>
        <option><strong>Th·∫£i ra m√¥i tr∆∞·ªùng</strong></option>
      </select>
      <label><strong>üìù Ghi ch√∫:</strong></label>
      <textarea id="ghichu" placeholder="Nh·∫≠p ghi ch√∫ th√™m n·∫øu c·∫ßn..."></textarea>
      <button type="submit" class="btn">‚ûï <strong>Th√™m d·ªØ li·ªáu</strong></button>
    </form>
    <div class="kpi-row" id="kpis"></div>
    <h2 style="font-size:1.3em;"><strong>üìã B·∫£ng t·ªïng h·ª£p d·ªØ li·ªáu</strong></h2>
    <div class="table-wrap">
      <table id="wasteTable">
        <thead>
          <tr>
            <th><strong>Ng√†y</strong></th>
            <th><strong>B·ªô ph·∫≠n</strong></th>
            <th><strong>Lo·∫°i r√°c</strong></th>
            <th><strong>Tr·ªçng l∆∞·ª£ng (kg)</strong></th>
            <th><strong>Th·ªÉ t√≠ch (ml)</strong></th>
            <th><strong>ƒê∆∞·ªùng ƒëi c·ªßa r√°c</strong></th>
            <th><strong>Ghi ch√∫</strong></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <h2 style="font-size:1.3em;"><strong>üìä Bi·ªÉu ƒë·ªì t·ªïng h·ª£p theo lo·∫°i r√°c</strong></h2>
    <div id="barchart" class="chart-bar"></div>
  </div>
  <div id="tab-dashboard" class="tab-content">
    <h2><strong>üìä Dashboard T·ªïng h·ª£p</strong></h2>
    <div class="kpi-row" id="kpis-dashboard"></div>
    <!-- T√πy ch·ªânh th√™m c√°c ph·∫ßn t·ªïng h·ª£p n·∫øu mu·ªën -->
  </div>
  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzNMUlXHG9VgZa1Bcqf4Et3od9W_MLVVMl4A2tFGuWVK-zq9N9xaJZ-WYURC7D0rznPnw/exec';

    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
      if(tab === 'input') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('tab-input').classList.add('active');
      } else {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('tab-dashboard').classList.add('active');
      }
    }

    async function loadSharedData() {
      const response = await fetch(GOOGLE_SCRIPT_URL);
      const data = await response.json();
      updateTable(data);
      updateKPI(data);
      updateBarChart(data);
    }

    function updateTable(data) {
      const tb = document.getElementById('wasteTable').querySelector('tbody');
      tb.innerHTML = '';
      for(const row of data){
        let tr = tb.insertRow();
        tr.insertCell().innerText = row.ngay;
        tr.insertCell().innerHTML = `<span><strong>${row.bophan}</strong></span>`;
        tr.insertCell().innerHTML = `<strong>${row.loairac}</strong>`;
        tr.insertCell().innerText = row.trongluong;
        tr.insertCell().innerText = row.thetich || '';
        tr.insertCell().innerText = row.duongdi || '';
        tr.insertCell().innerText = row.ghichu || '';
      }
    }

    function updateKPI(data) {
      let total = 0, organic = 0, recycle = 0, difficult = 0, hazard = 0;
      for(const row of data){
        let val = parseFloat(row.trongluong) || 0;
        total += val;
        if(row.loairac === "H·ªØu c∆°") organic += val;
        else if(row.loairac === "T√°i ch·∫ø") recycle += val;
        else if(row.loairac === "Kh√≥ t√°i ch·∫ø") difficult += val;
        else if(row.loairac === "Nguy h·∫°i") hazard += val;
      }
      document.getElementById('kpis').innerHTML = `
        <div class="kpi-block"><div class="kpi-title"><strong>T·ªïng tr·ªçng l∆∞·ª£ng</strong></div><div class="kpi-num">${total.toFixed(2)} kg</div></div>
        <div class="kpi-block"><div class="kpi-title"><strong>H·ªØu c∆°</strong></div><div class="kpi-num">${organic.toFixed(2)} kg</div></div>
        <div class="kpi-block"><div class="kpi-title"><strong>T√°i ch·∫ø</strong></div><div class="kpi-num">${recycle.toFixed(2)} kg</div></div>
        <div class="kpi-block"><div class="kpi-title"><strong>Kh√≥ t√°i ch·∫ø</strong></div><div class="kpi-num">${difficult.toFixed(2)} kg</div></div>
        <div class="kpi-block"><div class="kpi-title"><strong>Nguy h·∫°i</strong></div><div class="kpi-num">${hazard.toFixed(2)} kg</div></div>
      `;
    }

    function updateBarChart(data) {
      let barData = { "H·ªØu c∆°": 0, "T√°i ch·∫ø": 0, "Kh√≥ t√°i ch·∫ø": 0, "Nguy h·∫°i": 0 };
      for(const row of data){
        let val = parseFloat(row.trongluong) || 0;
        if(row.loairac in barData) barData[row.loairac] += val;
      }
      const all = Object.entries(barData);
      let max = Math.max(...all.map(d => d[1]), 1);
      let html = '';
      const colorMap = {
        "H·ªØu c∆°": "#23b486",
        "T√°i ch·∫ø": "#1976d2",
        "Kh√≥ t√°i ch·∫ø": "#ef5350",
        "Nguy h·∫°i": "#e68161"
      };
      for(const [l, v] of all){
        const height = (v / max * 160 + 20);
        html += `<div class="bar" style="height:${height}px; background:linear-gradient(to top,${colorMap[l]},#42a5f5);" title="${l}: ${v.toFixed(2)} kg">
          ${v > 0 ? `<span><strong>${v.toFixed(1)}</strong></span>` : ''}
        </div>`;
      }
      document.getElementById('barchart').innerHTML = html;
    }

    document.getElementById('wasteForm').onsubmit = async function(e){
      e.preventDefault();
      let ng = document.getElementById('ngay').value;
      let bp = document.getElementById('bophan').value;
      let lr = document.getElementById('loairac').value;
      let tl = document.getElementById('trongluong').value;
      let tt = document.getElementById('thetich').value;
      let dd = document.getElementById('duongdi').value;
      let gc = document.getElementById('ghichu').value;

      if(!ng || !bp || !lr || !tl){
        alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!');
        return;
      }
      const newData = { ngay: ng, bophan: bp, loairac: lr, trongluong: tl, thetich: tt, duongdi: dd, ghichu: gc };
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(newData)
        });
        alert('‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu v√† g·ª≠i l√™n Google Sheets th√†nh c√¥ng!');
        await loadSharedData();
        this.reset();
      } catch(error) {
        alert('‚ö†Ô∏è L·ªói khi g·ª≠i l√™n Google Sheets: ' + error.message);
      }
    }

    window.addEventListener("DOMContentLoaded", function(){ loadSharedData(); });
  </script>
</body>
</html>

